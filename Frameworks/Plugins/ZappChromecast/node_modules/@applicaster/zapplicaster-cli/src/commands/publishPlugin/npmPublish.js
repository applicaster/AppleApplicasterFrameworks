const { runInShellAsync } = require("../../shell");
const logger = require("../../logger");

async function npmPublish(configuration) {
  const { dryRun, yarn, next, version, pluginPath } = configuration;

  logger.log(
    `Publishing your plugin to the npm registry with ${yarn ? "yarn" : "npm"}`
  );

  const cmdOptions = { cwd: pluginPath };

  let publishCommand = yarn
    ? "yarn publish --no-git-tag-version"
    : "npm publish";

  if (dryRun) {
    if (yarn) {
      throw new Error("yarn doesn't support dry runs");
    }
    publishCommand += " --dry-run";
  }

  if (next) {
    publishCommand += " --tag next";
  }

  if (version) {
    if (yarn) {
      publishCommand += ` --new-version ${version}`;
    } else {
      await runInShellAsync(`npm version ${version}`, cmdOptions);
    }
  }

  try {
    logger.log(`running command ${publishCommand}`);
    await runInShellAsync(publishCommand, cmdOptions);
  } catch (e) {
    throw e;
  }

  return true;
}

module.exports = { npmPublish };
