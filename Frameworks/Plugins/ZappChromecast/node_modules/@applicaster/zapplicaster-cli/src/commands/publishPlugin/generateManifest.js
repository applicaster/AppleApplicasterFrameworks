const R = require("ramda");
const { resolve } = require("path");
const { inspect } = require("util");

const { writeJsonToFile } = require("../../file");
const logger = require("../../logger");

function renderManifest({ manifestConfig, pluginPath, version, dryRun }) {
  return async function(platform) {
    const manifest = manifestConfig({ platform, version });

    if (dryRun) {
      logger.log("Running with --dry-run flag. Not writing manifests");
      logger.log("manifest: ", inspect(manifest));
      return true;
    }

    return writeJsonToFile(
      `${pluginPath}/manifests/${platform}.json`,
      manifest
    );
  };
}

async function generateManifest(configuration) {
  const { pluginPath, platforms, version, dryRun } = configuration;

  try {
    const manifestConfig = require(resolve(
      pluginPath,
      "manifests/manifest.config.js"
    ));

    const manifestRenderer = renderManifest({
      manifestConfig,
      pluginPath,
      version,
      dryRun,
    });

    return Promise.all(R.map(manifestRenderer, platforms));
  } catch (e) {
    throw new Error(
      "An error occured when generating the manifest: " + e.message
    );
  }
}

module.exports = { generateManifest };
