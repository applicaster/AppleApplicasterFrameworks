import React from "react";
import { shallow } from "enzyme";
import { TouchableOpacity, View } from "react-native";
import { shallowToJson } from "enzyme-to-json";
import configureStore from "redux-mock-store";
import * as R from "ramda";

import { List } from "../index";
import { ListComponent } from "../List";

const feedData = {
  type: { value: "feed" },
  title: "feed title",
  entry: [
    {
      id: 123,
      title: "feed entry",
    },
  ],
};

const styles = {
  list: {
    headerUnderlineColor: "#ffabcabc",
  },
};

const componentProps = {};
const componentPropsWithData = {
  CellRenderer: jest.fn(),
  component: { styles: {} },
  zappPipesData: {
    loading: false,
    data: feedData,
  },
  styles,
  onLoadFinished: jest.fn(),
  navigator: { push: jest.fn() },
};

const rivers = {
  A1234: {
    id: "A1234",
    name: "home",
  },
};

const store = configureStore()({ styles, rivers });

describe("<List />", () => {
  it("renders correctly", () => {
    const wrapper = shallow(<List {...componentPropsWithData} />, {
      context: { store },
    });

    expect(shallowToJson(wrapper)).toMatchSnapshot();
  });
});

describe("<ListComponent />", () => {
  it("renders the placeholder correctly", () => {
    const wrapper = shallow(<ListComponent {...componentProps} />);
    expect(shallowToJson(wrapper)).toMatchSnapshot();
  });

  it("renders the data correctly", () => {
    const wrapper = shallow(<ListComponent {...componentPropsWithData} />);
    expect(shallowToJson(wrapper)).toMatchSnapshot();
  });

  it("renders the header when the title exists", () => {
    const wrapper = shallow(<ListComponent {...componentPropsWithData} />);
    const _wrapper = wrapper.instance().renderHeader();
    expect(shallowToJson(_wrapper)).toMatchSnapshot();
  });

  it("does not render the header if the title is empty", () => {
    const zappPipesData = {
      loaded: true,
      data: R.omit(["title"], feedData),
    };
    const wrapper = shallow(
      <ListComponent
        component={{ styles: {} }}
        zappPipesData={zappPipesData}
        styles={styles}
        onLoadFinished={jest.fn()}
      />
    );

    const _wrapper = wrapper.instance().renderHeader();
    expect(shallowToJson(_wrapper)).toMatchSnapshot();
  });

  it("renders an empty list if feed has no entries", () => {
    const zappPipesData = {
      loaded: true,
      data: R.merge(feedData, { entry: null }),
    };
    const wrapper = shallow(
      <ListComponent
        zappPipesData={zappPipesData}
        styles={styles}
        onLoadFinished={jest.fn()}
      />
    );

    const _wrapper = shallow(wrapper.instance().renderComponent(zappPipesData));
    expect(shallowToJson(_wrapper)).toMatchSnapshot();
  });

  it("renders an item", () => {
    const item = feedData.entry[0];
    const index = 1;
    const wrapper = shallow(<ListComponent {...componentPropsWithData} />);
    const _wrapper = shallow(wrapper.instance().renderItem({ item, index }));
    expect(shallowToJson(_wrapper)).toMatchSnapshot();
  });

  it("navigates to the item when tapping on it", () => {
    const item = feedData.entry[0];
    const wrapper = shallow(<ListComponent {...componentPropsWithData} />);
    const navigateToSpy = jest.spyOn(wrapper.instance(), "navigateTo");

    const _wrapper = shallow(
      <View>{wrapper.instance().renderItem({ item })}</View>
    );

    _wrapper.find(TouchableOpacity).simulate("press");

    expect(navigateToSpy).toHaveBeenCalledWith(item);
    expect(componentPropsWithData.navigator.push).toHaveBeenCalledWith(item);

    navigateToSpy.mockRestore();
  });

  it("extracts the id for any item, as a string", () => {
    const item = { id: 1234 };
    const index = 0;
    const wrapper = shallow(<ListComponent {...componentPropsWithData} />);
    expect(wrapper.instance()._keyExtractor(item, index)).toBe(
      `${index}${item.id}`
    );
  });
});
